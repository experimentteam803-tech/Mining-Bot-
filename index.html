<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CoinMine App - Firebase Static User</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
<style>
/* Basic Reset and Global Styles */
*{margin:0;padding:0;box-sizing:border-box;font-family:'Poppins', sans-serif}
body{
  background:linear-gradient(180deg,#000000,#141e30);
  color:white;
  min-height:100vh;
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:flex-start;
}
/* Header (Navigation Bar) */
header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  width:100%;
  padding:15px 20px;
  background:rgba(0,0,0,0.8);
  box-shadow:0 2px 8px rgba(0,0,0,0.6);
  position:fixed;
  top:0;
  z-index:100;
}
/* --- UPDATED PROFILE & COPY BUTTON LAYOUT --- */
header .profile-container {
    display: flex;
    flex-direction: column; /* Stack profile info and details */
    align-items: flex-start;
}
header .profile{
    display:flex;
    align-items:center;
    gap:10px;
    cursor: pointer; /* Make the profile area clickable */
    z-index: 101; /* Ensure profile is above details for click */
}
header .profile img{width:45px;height:45px;border-radius:50%;border:2px solid #32cd32}
header .profile span{font-weight:600;color:#90ee90}

#profileDetails {
    display: none; /* Initially hidden */
    background: #333;
    padding: 5px 10px;
    border-radius: 5px;
    margin-top: 5px; /* Space below the main profile info */
    position: absolute;
    top: 60px; /* Position below the header */
    left: 20px;
    box-shadow: 0 4px 8px rgba(0,0,0,0.5);
    z-index: 99;
    white-space: nowrap; /* Keep content on one line */
    display: flex;
    align-items: center;
    font-size: 14px;
}

#profileIdText {
    color: #ffd700;
    margin-right: 10px;
}

#copyIdIcon {
    background: none;
    border: none;
    color: #fff;
    cursor: pointer;
    font-size: 18px; /* Icon size */
    padding: 2px 5px;
    transition: color 0.2s;
}
#copyIdIcon:hover {
    color: #90ee90;
}

header .msg-icon{cursor:pointer;font-size:26px;color:#32cd32}

/* Main Content Area */
main{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:flex-start;
  width:100%;
  padding-top:70px;
  padding-bottom: 90px;
}
.section{display:none;width:100%;padding:20px;animation:fadeIn 0.3s ease;}
#home{display:block;}

/* --- ADJUSTED Home Section Styles --- */
#home .balance-display {
    text-align: center;
    margin-bottom: 20px;
}
#totalCoins{font-size:48px;color:#ffd700;font-weight:700;text-shadow: 0 0 10px rgba(255, 215, 0, 0.5);}
#home .balance-display h2{font-size:24px;color:#90ee90; margin-top: -10px;}

.mining-hub {
    background: rgba(255, 255, 255, 0.05);
    border-radius: 15px;
    padding: 25px 20px;
    width: 100%;
    max-width: 380px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.2);
    text-align: center;
}

.circle-container{position:relative;display:flex;align-items:center;justify-content:center;width: 100%;}
.circle {width:250px; height:250px; border-radius:50%; background: #0d0d0d; display:flex; align-items:center; justify-content:center; position: relative; cursor:pointer; overflow:hidden; box-shadow: inset 0 0 50px rgba(50, 205, 50, 0.5), 0 0 60px rgba(50, 205, 50, 0.8), 0 0 100px rgba(50, 205, 50, 0.4); transition: box-shadow 0.3s ease-out; margin-bottom: 20px;}
.circle span{font-size:28px; font-weight:700; color: #ffdd57; z-index:10;}
.circle.mining-active-glow {animation: pulseGlow 2s infinite alternate;}
@keyframes pulseGlow {
    0% {box-shadow: inset 0 0 50px rgba(50, 205, 50, 0.5), 0 0 60px rgba(50, 205, 50, 0.8), 0 0 100px rgba(50, 205, 50, 0.4);}
    100% {box-shadow: inset 0 0 70px rgba(0, 255, 0, 0.7), 0 0 80px rgba(0, 255, 0, 1), 0 0 120px rgba(0, 255, 0, 0.6);}
}

/* --- NEW PROFESSIONAL MINING ANIMATION --- */
.coin-particle {
    position: absolute;
    font-size: 24px;
    z-index: 1000;
    animation: fly-up 2s ease-out forwards;
    pointer-events: none; /* Prevent particles from being clickable */
}
@keyframes fly-up {
    0% {
        transform: translateY(0) scale(1);
        opacity: 1;
    }
    100% {
        transform: translateY(-200px) scale(0.5);
        opacity: 0;
    }
}

/* Common button style for mine and watch ad */
button.action-btn{width: 100%; padding:14px 28px;border-radius:30px;font-weight:700;font-size:18px;cursor:pointer;margin-top:0;transition:0.3s;display: block; border: none;}
button.action-btn:hover:enabled{filter: brightness(1.1);}
button.action-btn:disabled{cursor: not-allowed; opacity: 0.7;}

.mining-hub .ad-btn {
    background: #ffd700;
    color: #000;
    box-shadow: 0 4px 15px rgba(255, 215, 0, 0.5);
    margin-bottom: 8px;
}
.mining-hub .mine-btn {
    background: #32cd32;
    color: #000;
    box-shadow: 0 4px 15px rgba(50, 205, 50, 0.5);
}

#adStatus {color: #ffd700; font-size: 16px; margin-bottom: 15px; font-weight: 600; text-align: center;}
#miningCountdown {color: #90ee90; font-size: 16px; margin-top: 8px; font-weight: 600; text-align: center; min-height: 24px;}


.wallet-summary {
    background: #282828;
    padding: 20px;
    border-radius: 10px;
    margin: 20px 0;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
    text-align: center;
}
.balance-info { margin-bottom: 20px; }
.balance-label { font-size: 14px; color: #aaa; }
.balance-value { font-size: 36px; font-weight: 700; color: #ffd700; }
.value-inr { font-size: 16px; color: #90ee90; margin-top: 5px; }
.wallet-summary button {
    background: #32cd32;
    color: #000;
    padding: 10px 20px;
    border: none;
    border-radius: 20px;
    font-weight: 600;
    cursor: pointer;
    transition: 0.3s;
}
.withdrawal-note { font-size: 12px; color: #aaa; margin-top: 15px; }
.referral-box {
    background: #282828;
    padding: 15px;
    border-radius: 8px;
    margin-bottom: 20px;
    border: 1px dashed #32cd32;
    text-align: center;
}
#refLink {
    font-size: 14px;
    color: #ffd700;
    word-break: break-all;
    margin-top: 5px;
}
.referral-details {
    padding: 15px;
    background: #1c1c1c;
    border-radius: 8px;
    margin-bottom: 20px;
}
.referral-instruction-list {
    list-style: none;
    padding-left: 0;
    text-align: left;
}
.referral-instruction-list li {
    margin-bottom: 10px;
    font-size: 15px;
    color: #ccc;
    padding-left: 20px;
    position: relative;
}
.referral-instruction-list li::before {
    content: '‚òÖ';
    color: #ffd700;
    font-weight: bold;
    display: inline-block;
    width: 1em;
    margin-left: -1em;
}
.share-btn {
    background: #ffd700;
    color: #000;
    padding: 12px 25px;
    border: none;
    border-radius: 25px;
    font-weight: 700;
    cursor: pointer;
    transition: 0.3s;
    width: 80%;
}


/* Modal Styles for Withdrawal */
.modal { display: none; position: fixed; z-index: 200; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.8); padding-top: 100px;}
.modal-content { background: #282828; margin: 5% auto; padding: 30px; border-radius: 15px; width: 90%; max-width: 400px; position: relative; color: white; box-shadow: 0 8px 30px rgba(0, 0, 0, 0.7);}
.close-btn { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer;}
.withdraw-button { width: 100%; padding: 12px; background: #ffd700; color: #000; font-weight: 700; border: none; border-radius: 8px; margin-top: 15px; cursor: pointer; transition: 0.3s;}
.form-group { margin-bottom: 15px; text-align: left; }
.form-group label { display: block; margin-bottom: 5px; font-weight: 600; color: #90ee90; }
.form-group input { width: 100%; padding: 10px; border: 1px solid #555; border-radius: 5px; background: #1c1c1c; color: white; }

/* Withdrawal History Styles */
.history-container {
    margin-top: 30px;
    padding: 15px;
    background: #1c1c1c;
    border-radius: 10px;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.5);
}
.history-container h3 {
    color: #ffd700;
    margin-bottom: 15px;
    text-align: center;
}
.history-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px 0;
    border-bottom: 1px dashed #333;
    font-size: 14px;
}
.history-item:last-child {
    border-bottom: none;
}
.status-pending { color: #ff9800; font-weight: 700; } /* Orange */
.status-paid { color: #4CAF50; font-weight: 700; } /* Green */
.status-failed { color: #f44336; font-weight: 700; } /* Red */
.history-amount { color: #90ee90; font-weight: 600; }


/* --- NEW TASK VERIFICATION BOX STYLES --- */
.task-verification-box {
    background: #1c1c1c;
    border: 1px solid #ffd700;
    border-radius: 8px;
    padding: 15px;
    margin-bottom: 25px;
    text-align: center;
}
.task-verification-box p {
    color: #ccc;
    font-size: 14px;
    line-height: 1.6;
    margin-bottom: 15px;
}
.task-verification-box .button-container {
    display: flex;
    justify-content: space-around;
    gap: 10px;
}
.task-verification-box .task-action-btn {
    flex: 1;
    padding: 10px;
    border-radius: 20px;
    border: none;
    font-weight: 600;
    cursor: pointer;
    text-decoration: none;
    display: inline-block;
    font-size: 14px;
    transition: filter 0.2s;
}
.task-verification-box .task-action-btn:hover {
    filter: brightness(1.15);
}
.task-verification-box .copy-btn {
    background-color: #32cd32;
    color: #000;
}
.task-verification-box .send-btn {
    background-color: #2575fc;
    color: #fff;
}


/* Footer Navigation Bar */
.navbar{display:flex;justify-content:space-around;background:rgba(0,0,0,0.9);padding:15px 0;border-top:2px solid #32cd32;position:fixed;bottom:0;width:100%;z-index:100;}
.nav-btn{background:none;border:none;color:white;font-size:18px;padding:8px 12px;border-radius:10px;cursor:pointer;transition:0.2s;font-weight:600;}
.nav-btn.active,.nav-btn:hover{color:#32cd32;background:rgba(50, 205, 50, 0.2);}

@keyframes fadeIn{from{opacity:0;}to{opacity:1;}}


/* --- NEW GIFT SECTION STYLES --- */
#gift {
  --primary-color: #6a11cb;
  --secondary-color: #2575fc;
  --text-color: #222;
  --subtle-text-color: #555;
  --background-gradient-start: #f06;
  --background-gradient-end: #4a00e0;
  --card-background: #fff;
  --highlight-color: #ff5722;
  --accent-color: #009688;
  --success-color: #4CAF50;
  --box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
  background: linear-gradient(135deg, var(--background-gradient-start), var(--background-gradient-end));
  display: flex; /* Overriding .section display:none when active */
  justify-content: center;
  align-items: center;
  padding: 20px;
}
#gift .container {
  background: var(--card-background);
  padding: 30px;
  border-radius: 12px;
  box-shadow: var(--box-shadow);
  text-align: center;
  width: 100%;
  max-width: 420px;
  transition: transform 0.3s ease, box-shadow 0.3s ease;
}
#gift .container:hover {
  transform: translateY(-5px);
  box-shadow: 0 15px 40px rgba(0, 0, 0, 0.2);
}
#gift h2 {
  margin-top: 0;
  margin-bottom: 5px;
  color: var(--primary-color);
  font-weight: 700;
  font-size: 1.8em;
  text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
}
#gift .sub-text {
  font-size: 0.9em;
  color: var(--accent-color);
  margin-bottom: 5px;
  font-weight: 500;
}
#gift .highlight {
  font-size: 1em;
  color: var(--highlight-color);
  margin-bottom: 20px;
  font-weight: 600;
  padding: 5px 0;
  border-bottom: 1px solid #eee;
  border-top: 1px solid #eee;
  background: linear-gradient(to right, #fffaf0, #fff);
}
#gift input {
  width: 100%;
  padding: 15px;
  border: 2px solid #ddd;
  border-radius: 8px;
  margin-bottom: 20px;
  font-size: 1em;
  color: var(--text-color);
  box-sizing: border-box;
  transition: border-color 0.3s;
}
#gift input:focus {
  border-color: var(--primary-color);
  outline: none;
  box-shadow: 0 0 0 3px rgba(106, 17, 203, 0.25);
}
#gift button {
  width: 100%;
  padding: 15px;
  border: none;
  border-radius: 8px;
  font-size: 1em;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s ease;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  margin-bottom: 15px;
  box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
}
#gift .redeem-btn {
  background: var(--primary-color);
  color: white;
  box-shadow: 0 5px 15px rgba(106, 17, 203, 0.3);
}
#gift .redeem-btn:hover {
  background: #500e9f;
  box-shadow: 0 8px 20px rgba(106, 17, 203, 0.4);
  transform: translateY(-2px);
}
#gift .claim-btn {
  background: var(--secondary-color);
  color: white;
  margin-bottom: 0 !important;
  box-shadow: 0 5px 15px rgba(37, 117, 252, 0.3);
}
#gift .claim-btn:hover {
  background: #1a62d0;
  box-shadow: 0 8px 20px rgba(37, 117, 252, 0.4);
  transform: translateY(-2px);
}
#gift p {
  color: var(--text-color);
}
#gift p[style*="‚Äî OR GET A FREE CODE ‚Äî"] {
  color: #607d8b !important;
  font-weight: 500;
}
#gift .note {
  margin-top: 20px;
  font-size: 0.9em;
  color: var(--accent-color);
  padding-top: 10px;
  border-top: 1px dashed #eee;
  font-weight: 500;
}
#gift #claimButtonContainer {
  display: block;
}
#gift .redeemed-message {
  display: none;
  padding: 15px;
  border-radius: 8px;
  background: var(--success-color);
  color: white;
  font-weight: 600;
  text-align: center;
  margin-bottom: 20px;
  font-size: 1.1em;
  box-shadow: 0 4px 10px rgba(76, 175, 80, 0.3);
  letter-spacing: 0.3px;
}


</style>
</head>
<body>

<div id="app-content" style="width: 100%;">
    <header>
    <div class="profile-container">
        <div class="profile" onclick="showProfileDetails()">
            <img id="profile-img" src="https://i.pravatar.cc/45" alt="Profile">
            <span id="username">Username</span>
        </div>

        <div id="profileDetails">
            <span id="profileIdText">ID: Loading...</span>
            <button id="copyIdIcon" onclick="copyUserId()">
                üìã
            </button>
        </div>
    </div>
    <div class="msg-icon" onclick="showMsg()">üí¨</div>
    </header>
    <main>
    <section id="home" class="section">
        <div class="balance-display">
            <div id="totalCoins"><span id="coinCount">0</span></div>
            <h2>Your Coins</h2>
        </div>

        <div class="mining-hub">
            <div class="circle-container">
                <div class="circle" id="mineCircle">
                    <span id="coinInsideCircle">0</span>
                </div>
            </div>
            
            <button class="action-btn ad-btn" id="watchAdBtn" onclick="watchAd()">üé¨ Watch Ad</button>
            <div id="adStatus">Ads Watched: 0/10</div>
        
            <button class="action-btn mine-btn" id="mineBtn" onclick="startDailyMining()">ü™ô Start Mining</button>
            <div id="miningCountdown">Click to start 1 hour session</div>
        </div>
    </section>

    <section id="task" class="section">
        <!-- ================== NEW TASK VERIFICATION BOX ================== -->
        <div class="task-verification-box">
            <p><strong>After Completing a Task:</strong><br>Please send your User ID and Task Name to our Customer Service Team for quick verification and reward processing.</p>
            <div class="button-container">
                <button class="task-action-btn copy-btn" onclick="window.copyUserId()">üìã Copy User ID</button>
                <a href="https://t.me/Costumer_123" target="_blank" class="task-action-btn send-btn">‚úâÔ∏è Send Message</a>
            </div>
        </div>
        <!-- ============================================================= -->

        <div id="taskList">
            <h2 style="text-align: center;">üß© Daily Tasks</h2>
            <p style="margin-bottom: 20px; color:#aaa; text-align: center;">Complete simple tasks and earn rewards.</p>
            <p style="text-align: center; color: #777; margin-top: 50px;">Loading tasks...</p>
        </div>
    </section>
    
    <!-- ================== NEW GIFT SECTION ================== -->
    <section id="gift" class="section">
      <div class="container">
        <h2><span style="color: #FFD700;">‚òÖ</span> Redeem Gift Code</h2>
        <p class="sub-text">A new gift code will be available every 6 hours.</p>
        <p class="highlight">You can win up to <span style="font-size: 1.1em;">10,000</span> coins from gift codes!</p>
    
        <input type="text" id="giftCode" placeholder="Enter your gift code here">
        <button class="redeem-btn" onclick="redeemCode()">Redeem Code</button>
        <p style="font-size: 0.9em; margin: 15px 0;">‚Äî OR GET A FREE CODE ‚Äî</p>
    
        <div id="claimButtonContainer">
          <button class="claim-btn" id="claimBtn1" onclick="claimCode(this, 'placeholder')">
            Claim Free Gift Code üöÄ
          </button>
        </div>
    
        <div id="redeemedMessage" class="redeemed-message">
          Code successfully redeemed! ü•≥
        </div>
    
        <p class="note">Claim a code and redeem it to earn coins üí∞</p>
      </div>
    </section>
    <!-- ======================================================= -->

    <section id="wallet" class="section">
        <h2 style="text-align: center;">üíº Wallet</h2>
        <div class="wallet-summary">
            <div class="balance-info">
                <div class="balance-label">Current Balance (Coins)</div>
                <div class="balance-value"><span id="walletCoins">0</span></div>
                <div class="value-inr">‚Çπ <span id="walletValue">0.00</span> (1000 Coins ‚âà ‚Çπ1)</div>
            </div>
            <button onclick="showWithdrawalModal()">UPI Withdrawal</button>
            <div class="withdrawal-note">
                Minimum withdrawal amount is **10,000 Coins** (‚Çπ10.00).
            </div>
        </div>

        <div class="history-container">
            <h3>Withdrawal History</h3>
            <div id="withdrawalHistoryList">
                <p style="text-align: center; color: #777;">Loading history...</p>
            </div>
        </div>
        </section>
    <section id="referral" class="section">
        <h2 style="text-align: center;">üîó Referral Program</h2>
        <div id="referral-content">
            <p style="text-align: center; color: #ccc; margin-bottom: 25px;">Invite your friends to CoinMine and earn substantial rewards!</p>

            <div class="referral-box">
                <div style="font-size: 16px; color: #90ee90; font-weight: 600;">Your Unique Referral Link:</div>
                <p id="refLink">https://coinmine.app/ref?user=DemoUser</p>
            </div>

            <div class="referral-details">
                <h3 style="color: #fff; margin-bottom: 15px;">How It Works:</h3>
                <ul class="referral-instruction-list">
                    <li><strong>Share:</strong> Share your unique link with friends and family.</li>
                    <li><strong>Signup Bonus:</strong> You earn **700 Coins** immediately when your friend successfully signs up using your link.</li>
                    <li><strong>Lifetime Commission:</strong> You earn a **5% commission** on all coins your referred users mine, forever!</li>
                </ul>
                <p style="text-align: center; color: #ffd700; font-weight: 600; margin-bottom: 20px;">The more you share, the more you earn!</p>
            </div>

            <button class="share-btn" onclick="shareReferralLink()">
                üì¢ Share My Link Now
            </button>
        </div>
    </section>

    </main>
    <nav class="navbar">
    <button class="nav-btn active" onclick="showSection('home', this)">üè† Home</button>
    <button class="nav-btn" onclick="showSection('task', this)">üß© Task</button>
    <button class="nav-btn" onclick="showSection('gift', this)">üéÅ Gift</button>
    <button class="nav-btn" onclick="showSection('wallet', this)">üíº Wallet</button>
    <button class="nav-btn" onclick="showSection('referral', this)">üîó Ref</button>
    </nav>
</div>


<div id="withdrawalModal" class="modal">
    <div class="modal-content">
        <span class="close-btn" onclick="closeWithdrawalModal()">&times;</span>
        <h3>UPI Withdrawal</h3>
        <p style="color:#aaa; text-align: center; margin-bottom: 15px;">Minimum: 10,000 Coins (‚Çπ10.00)</p>

        <div class="form-group">
            <label for="upiAmount">Coins to Withdraw:</label>
            <input type="number" id="upiAmount" placeholder="Min 10000" oninput="checkWithdrawalEligibility()">
            <small id="inrValueText" style="color: #90ee90;"></small>
        </div>
        <div class="form-group">
            <label for="upiId">Your UPI ID:</label>
            <input type="text" id="upiId" placeholder="example@bankupi">
        </div>
        <button class="withdraw-button" id="submitWithdrawalBtn" disabled onclick="submitWithdrawal()">Submit Withdrawal Request</button>
        <small style="display: block; text-align: center; color: #f44336; margin-top: 10px;">Withdrawals processed within 24 hours.</small>
    </div>
</div>

<!-- ================== MAIN APP SCRIPT ================== -->
<script type="module">
// --- FIREBASE IMPORTS ---
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getAnalytics } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-analytics.js";
import { getDatabase, ref, set, onValue, update, push, query, orderByChild, equalTo } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

// --- FIREBASE CONFIGURATION ---
const firebaseConfig = {
  apiKey: "AIzaSyAYDF5fRbHfjeWXXVxkSMiJY4ZL5KHa9s8",
  authDomain: "mining-bot-2f220.firebaseapp.com",
  projectId: "mining-bot-2f220",
  storageBucket: "mining-bot-2f220.firebasestorage.app",
  messagingSenderId: "343763715927",
  appId: "1:343763715927:web:2b142517de1f506bdfe012",
  measurementId: "G-CBVB9RHJJB"
};

// Initialize Firebase services
const app = initializeApp(firebaseConfig);
const analytics = getAnalytics(app);
const database = getDatabase(app);

// --- STATIC USER SETUP (NO AUTH) ---
const STATIC_USER_ID = 'static_demo_user';
const DB_NODE_PATH = 'users/' + STATIC_USER_ID;

// --- GLOBAL REFERENCES ---
const ADMIN_SETTINGS_REF = ref(database, 'admin_settings');
const TASKS_REF = ref(database, 'tasks');
const WITHDRAWALS_REF = ref(database, 'withdrawals');

// --- GLOBAL VARIABLES & CONSTANTS ---
window.coins = 0;
window.dailyMinedTimestamp = 0;
window.miningEndTime = 0;
window.adsWatched = 0;
window.adsWatchedTimestamp = 0;
window.dbRef = ref(database, DB_NODE_PATH);

const MINING_RATE_MS = 1500;
const ONE_HOUR_MS = 60 * 60 * 1000;
const ONE_DAY_MS = 24 * 60 * 60 * 1000;
const MIN_WITHDRAWAL_COINS = 10000;
// These are now dynamic, loaded from Admin Panel:
window.ADS_REQUIRED = 10; // Default
window.AD_REWARD_COINS = 5; // Default

// UI Elements
const mineButton = document.getElementById('mineBtn');
const watchAdBtn = document.getElementById('watchAdBtn');
const adStatusDisplay = document.getElementById('adStatus');
const mineCircle = document.getElementById('mineCircle');
const countdownDisplay = document.getElementById('miningCountdown');
const withdrawalModal = document.getElementById('withdrawalModal');
const submitWithdrawalBtn = document.getElementById('submitWithdrawalBtn');

// User ID Display Elements
const profileDetailsDiv = document.getElementById('profileDetails');
const profileIdTextSpan = document.getElementById('profileIdText');


// --- FIREBASE DATA HANDLING FUNCTIONS ---

function loadUserData() {
    onValue(window.dbRef, (snapshot) => {
        const data = snapshot.val();

        // Initial setup for the static user node
        if (!data) {
            console.log("Setting up initial data for static user.");
            const initialData = {
                coins: 0,
                dailyMinedTimestamp: 0,
                miningEndTime: 0,
                adsWatched: 0,
                adsWatchedTimestamp: 0,
                upiId: '',
                lastActive: Date.now()
            };
            set(window.dbRef, initialData); // Write initial data
            updateGlobalState(initialData);
            return;
        }

        // Update global state with fetched data, and update lastActive
        update(window.dbRef, { lastActive: Date.now() }); // Update for dashboard
        updateGlobalState(data);

        // Update the hidden ID text with the real ID
        profileIdTextSpan.innerText = `ID: ${STATIC_USER_ID}`;

        // Apply mining logic after data sync
        processDataForStateUpdate();

    }, (error) => {
        console.error("Firebase Read Error (User Data):", error);
        alert("Failed to load user data. Check Firebase rules.");
    });
}

function loadAdminSettings() {
    onValue(ADMIN_SETTINGS_REF, (snapshot) => {
        const settings = snapshot.val();
        if (settings) {
            // 1. Update Mining Ad Settings (required ads)
            if (settings.miningAds && settings.miningAds.required) {
                window.ADS_REQUIRED = settings.miningAds.required;
            } else {
                 window.ADS_REQUIRED = 10; // Fallback
            }

            // 2. Update Ad Task Reward
            if (settings.adTasks && settings.adTasks.reward) {
                window.AD_REWARD_COINS = settings.adTasks.reward;
            } else {
                window.AD_REWARD_COINS = 5; // Fallback
            }

            // Re-run the update logic since core constants might have changed
            updateMiningButtonState();
            updateAdStatus();
        }
    }, (error) => {
        console.error("Firebase Read Error (Admin Settings):", error);
    });
}

function loadLiveTasks() {
    const taskListDiv = document.getElementById('taskList');
    onValue(TASKS_REF, (snapshot) => {
        const tasks = snapshot.val();

        let html = `
            <h2 style="text-align: center;">üß© Daily Tasks</h2>
            <p style="margin-bottom: 20px; color:#aaa; text-align: center;">Complete simple tasks and earn rewards.</p>
        `;
        let activeTasksFound = false;

        if (tasks) {
            for (const taskId in tasks) {
                const task = tasks[taskId];
                if (task.active) {
                    activeTasksFound = true;
                    // Render the task item using the admin panel data structure
                    html += `
                        <div class="referral-details" style="border-left: 5px solid #ffd700; padding: 15px; margin-bottom: 15px; background: #1c1c1c;">
                            <h3 style="color: #90ee90; margin-bottom: 5px;">${task.name}</h3>
                            <p style="color: #fff; font-weight: 600;">Reward: <span style="color: #ffd700;">${task.reward.toLocaleString()} Coins</span></p>
                            <p style="font-size: 14px; color: #ccc; margin-top: 10px;">Instructions:</p>
                            <ul class="referral-instruction-list" style="margin-bottom: 15px;">
                                ${task.instructions.map(inst => `<li>${inst}</li>`).join('')}
                            </ul>
                            <a href="${task.link}" target="_blank" style="text-decoration: none;">
                                <button class="action-btn ad-btn" style="width: 100%; margin: 0; background: #32cd32; color: #000;">
                                    ${task.logoUrl ? `<img src="${task.logoUrl}" style="width: 20px; height: 20px; margin-right: 5px; vertical-align: middle;">` : ''}
                                    Complete Task
                                </button>
                            </a>
                        </div>
                    `;
                }
            }
        }

        if (!activeTasksFound) {
            html += '<p style="text-align: center; color: #777; margin-top: 50px;">No tasks available right now. Check back later!</p>';
        }

        taskListDiv.innerHTML = html;
    });
}

function loadWithdrawalHistory() {
    const historyList = document.getElementById('withdrawalHistoryList');
    const userWithdrawalsQuery = query(WITHDRAWALS_REF, orderByChild('userId'), equalTo(STATIC_USER_ID));

    onValue(userWithdrawalsQuery, (snapshot) => {
        const withdrawals = snapshot.val();
        let html = '';
        let withdrawalFound = false;

        if (withdrawals) {
            const sortedWithdrawals = Object.values(withdrawals).sort((a, b) => b.timestamp - a.timestamp);

            sortedWithdrawals.forEach(item => {
                withdrawalFound = true;
                const date = new Date(item.timestamp).toLocaleDateString();
                const time = new Date(item.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                const statusClass = `status-${item.status ? item.status.toLowerCase() : 'pending'}`;
                const statusText = item.status || 'Pending';
                const amountINR = (item.amount / 1000).toFixed(2);

                html += `
                    <div class="history-item">
                        <div>
                            <span class="history-amount">${item.amount.toLocaleString()} Coins</span>
                            <span style="color: #ccc;">(‚Çπ${amountINR})</span>
                        </div>
                        <div style="text-align: right;">
                            <span class="${statusClass}">${statusText}</span><br>
                            <span style="font-size: 0.8em; color: #777;">${date} ${time}</span>
                        </div>
                    </div>
                `;
            });
        }

        if (!withdrawalFound) {
            html = '<p style="text-align: center; color: #777;">No withdrawal requests found yet.</p>';
        }

        historyList.innerHTML = html;
    }, (error) => {
        console.error("Firebase Read Error (Withdrawal History):", error);
        historyList.innerHTML = '<p style="text-align: center; color: #f44336;">Failed to load history.</p>';
    });
}

function updateGlobalState(data) {
    window.coins = data.coins || 0;
    window.dailyMinedTimestamp = data.dailyMinedTimestamp || 0;
    window.miningEndTime = data.miningEndTime || 0;
    window.adsWatched = data.adsWatched || 0;
    window.adsWatchedTimestamp = data.adsWatchedTimestamp || 0;
    window.upiId = data.upiId || '';
}

function processDataForStateUpdate() {
    // Check if mining session ended while offline
    if (window.miningEndTime !== 0 && window.miningEndTime <= Date.now()) {
        stopMining(false);
    }

    // Cooldown/Reset check logic
    if (window.dailyMinedTimestamp !== 0 && window.canMineToday()) {
        // Cooldown is finished, reset data for new cycle
        updateDatabase({
            dailyMinedTimestamp: 0,
            adsWatched: 0,
            adsWatchedTimestamp: 0
        });
        window.dailyMinedTimestamp = 0;
        window.adsWatched = 0;
        window.adsWatchedTimestamp = 0;
    }

    // Update UI and button state based on current global variables
    updateCoinDisplays();
    updateMiningButtonState();
}

window.updateDatabase = (updates) => {
    const allUpdates = {
        coins: window.coins,
        dailyMinedTimestamp: window.dailyMinedTimestamp,
        miningEndTime: window.miningEndTime,
        adsWatched: window.adsWatched,
        adsWatchedTimestamp: window.adsWatchedTimestamp,
        upiId: window.upiId,
        ...updates
    };

    set(window.dbRef, allUpdates)
        .catch(error => console.error("Database Write Error:", error));
};


// --- HELPER FUNCTIONS ---

function updateCoinDisplays() {
    const inrValue = (window.coins / 1000).toFixed(2);
    document.getElementById('coinCount').innerText = window.coins.toLocaleString();
    document.getElementById('coinInsideCircle').innerText = window.coins.toLocaleString();
    document.getElementById('walletCoins').innerText = window.coins.toLocaleString();
    document.getElementById('walletValue').innerText = inrValue;
}

function formatTime(ms) {
    if (ms < 0) ms = 0;
    const seconds = Math.floor((ms / 1000) % 60);
    const minutes = Math.floor((ms / (1000 * 60)) % 60);
    const hours = Math.floor((ms / (1000 * 60 * 60)) % 24);

    const h = String(hours).padStart(2, '0');
    const m = String(minutes).padStart(2, '0');
    const s = String(seconds).padStart(2, '0');

    return `${h}:${m}:${s}`;
}

window.canMineToday = () => {
  return (Date.now() - window.dailyMinedTimestamp) >= ONE_DAY_MS;
}


// --- AD-BASED MINING LOGIC ---

window.watchAd = () => {
    if (window.adsWatched >= window.ADS_REQUIRED && !window.canMineToday()) {
        alert("Ads are complete and mining cooldown is active. Wait for the 24h reset.");
        updateMiningButtonState();
        return;
    }

    if (window.adsWatched >= window.ADS_REQUIRED && window.canMineToday()) {
        alert("A new session is ready to start. Please click 'Start Mining'.");
        updateMiningButtonState();
        return;
    }

    const miningStillActive = window.miningEndTime > Date.now() && window.miningEndTime !== 0;
    const isInCooldown = !window.canMineToday() && window.dailyMinedTimestamp !== 0;

    if (miningStillActive || isInCooldown) {
        alert("Cannot watch ads while mining is active or in cooldown.");
        return;
    }

    watchAdBtn.disabled = true;
    watchAdBtn.innerText = 'üé• Ad Playing... (3s)';

    setTimeout(() => {
        window.adsWatched++;
        window.coins += window.AD_REWARD_COINS;

        window.updateDatabase({
            coins: window.coins,
            adsWatched: window.adsWatched,
            adsWatchedTimestamp: Date.now()
        });

        if (window.adsWatched < window.ADS_REQUIRED) {
            watchAdBtn.disabled = false;
            watchAdBtn.innerText = 'üé¨ Watch Ad';
            alert(`Ad watched! +${window.AD_REWARD_COINS} Coins. ${window.ADS_REQUIRED - window.adsWatched} more ads needed to start mining.`);
        } else {
            watchAdBtn.innerText = '‚úÖ Ads Complete';
            alert(`Congratulations! You have watched ${window.ADS_REQUIRED} ads. You can now start mining!`);
        }
    }, 3000);
}

function updateAdStatus() {
    const miningStillActive = window.miningEndTime > Date.now() && window.miningEndTime !== 0;
    const isInCooldown = !window.canMineToday() && window.dailyMinedTimestamp !== 0;

    if (window.adsWatched >= window.ADS_REQUIRED) {
        adStatusDisplay.innerText = `Ads Complete! Mining unlocked.`;
        watchAdBtn.disabled = true;
        watchAdBtn.innerText = '‚úÖ Ads Complete';
        if (isInCooldown) {
            const remainingCooldown = (window.dailyMinedTimestamp + ONE_DAY_MS) - Date.now();
            adStatusDisplay.innerHTML = `Ads/Mining Reset in: ${formatTime(remainingCooldown)}`;
        }
    } else {
        adStatusDisplay.innerText = `Ads Watched: ${window.adsWatched}/${window.ADS_REQUIRED}`;
        watchAdBtn.disabled = miningStillActive || isInCooldown;
        watchAdBtn.innerText = 'üé¨ Watch Ad';
    }
}

// --- MINING FUNCTIONS ---

function startMiningAnimation() {
    const numParticles = 5;
    const mainContainer = document.querySelector('main');
    const circleRect = mineCircle.getBoundingClientRect();

    for (let i = 0; i < numParticles; i++) {
        const particle = document.createElement('div');
        particle.className = 'coin-particle';
        particle.innerText = 'ü™ô';
        
        // Start position centered on the circle, with a random offset
        const startX = circleRect.left + circleRect.width / 2 + (Math.random() - 0.5) * 80;
        const startY = circleRect.top + circleRect.height / 2 + (Math.random() - 0.5) * 80;
        
        particle.style.left = `${startX}px`;
        particle.style.top = `${startY}px`;
        
        // Stagger animation start
        particle.style.animationDelay = `${Math.random() * 0.5}s`;

        mainContainer.appendChild(particle);

        // Remove particle after animation ends
        setTimeout(() => {
            particle.remove();
        }, 2000);
    }
}

window.stopMining = (doUpdateState = true) => {
    if (window.miningInterval) clearInterval(window.miningInterval);
    if (window.remainingTimeInterval) clearInterval(window.remainingTimeInterval);
    window.miningInterval = null;
    window.remainingTimeInterval = null;
    mineCircle.classList.remove('mining-active-glow');

    window.miningEndTime = 0;
    window.updateDatabase({ miningEndTime: 0 });

    if (doUpdateState) updateMiningButtonState();
}

function updateCountdown() {
    const remainingSessionTime = window.miningEndTime - Date.now();

    if (remainingSessionTime <= 0) {
        window.stopMining();
        return;
    }
    mineCircle.classList.add('mining-active-glow');
    mineButton.disabled = true;
    mineButton.innerText = '‚õèÔ∏è Mining Active';
    mineButton.style.background = '#808080';
    countdownDisplay.innerText = 'Time Left: ' + formatTime(remainingSessionTime);
}

window.startDailyMining = () => {
  if (window.adsWatched < window.ADS_REQUIRED) {
      alert(`Please watch the required ${window.ADS_REQUIRED} ads before starting the mining session.`);
      return;
  }
  if (window.miningInterval) return;
  if (!window.canMineToday()){
    startCooldownCountdown();
    return;
  }

  const currentTime = Date.now();
  const endTime = currentTime + ONE_HOUR_MS;

  window.dailyMinedTimestamp = currentTime;
  window.miningEndTime = endTime;

  window.updateDatabase({
    dailyMinedTimestamp: currentTime,
    miningEndTime: endTime
  });

  window.miningInterval = setInterval(()=>{
    window.coins+=1;
    window.updateDatabase({ coins: window.coins });
    startMiningAnimation();
  }, MINING_RATE_MS);

  window.remainingTimeInterval = setInterval(updateCountdown, 1000);
  setTimeout(window.stopMining, ONE_HOUR_MS);
  updateCountdown();
}

function startCooldownCountdown() {
    if (window.remainingTimeInterval) clearInterval(window.remainingTimeInterval);

    window.remainingTimeInterval = setInterval(() => {
        const remainingCooldown = (window.dailyMinedTimestamp + ONE_DAY_MS) - Date.now();

        if (remainingCooldown <= 0) {
            clearInterval(window.remainingTimeInterval);
            window.remainingTimeInterval = null;
            if (window.dailyMinedTimestamp !== 0) {
                 window.updateDatabase({
                    dailyMinedTimestamp: 0,
                    adsWatched: 0,
                    adsWatchedTimestamp: 0
                });
            }
            updateMiningButtonState();
            return;
        }
        mineButton.disabled = true;
        mineButton.innerText = '‚è≥ Cooldown Active';
        mineButton.style.background = '#808080';
        countdownDisplay.innerText = 'Next Mine in: ' + formatTime(remainingCooldown);
        updateAdStatus();
    }, 1000);
}

function updateMiningButtonState() {
    const miningStillActive = window.miningEndTime > Date.now() && window.miningEndTime !== 0;
    const isAdsComplete = window.adsWatched >= window.ADS_REQUIRED;

    updateAdStatus();

    if (miningStillActive) {
        updateCountdown();
    } else if (!window.canMineToday() && window.dailyMinedTimestamp !== 0) {
        startCooldownCountdown();
    } else if (isAdsComplete) {
        if (window.miningInterval) clearInterval(window.miningInterval);
        if (window.remainingTimeInterval) clearInterval(window.remainingTimeInterval);
        mineCircle.classList.remove('mining-active-glow');

        mineButton.disabled = false;
        mineButton.innerText = 'ü™ô Start Mining';
        mineButton.style.background = '#32cd32';
        countdownDisplay.innerText = 'Ads Complete! Click to start 1 hour session';
    } else {
        if (window.miningInterval) clearInterval(window.miningInterval);
        if (window.remainingTimeInterval) clearInterval(window.remainingTimeInterval);
        mineCircle.classList.remove('mining-active-glow');
        mineButton.disabled = true;
        mineButton.innerText = `üîí Watch ${window.ADS_REQUIRED} Ads to Unlock Mining`;
        mineButton.style.background = '#808080';
        countdownDisplay.innerText = `Watch ${window.ADS_REQUIRED} ads to start a new session.`;
    }
}


// --- WITHDRAWAL FUNCTIONS ---

window.showWithdrawalModal = () => {
    withdrawalModal.style.display = "block";
    document.getElementById('upiAmount').value = '';
    document.getElementById('upiId').value = window.upiId; // Pre-fill UPI
    document.getElementById('inrValueText').innerText = '';
    submitWithdrawalBtn.disabled = true;
}

window.closeWithdrawalModal = () => {
    withdrawalModal.style.display = "none";
}

window.checkWithdrawalEligibility = () => {
    const amountInput = document.getElementById('upiAmount');
    const amount = Number(amountInput.value);
    const inrValueText = document.getElementById('inrValueText');

    inrValueText.style.color = '#90ee90';

    if (amount > 0) {
        const inrValue = (amount / 1000).toFixed(2);
        inrValueText.innerText = `Equivalent to ‚Çπ${inrValue}`;
    } else {
        inrValueText.innerText = '';
    }

    if (amount >= MIN_WITHDRAWAL_COINS && amount <= window.coins) {
        submitWithdrawalBtn.disabled = false;
    } else {
        submitWithdrawalBtn.disabled = true;
        if (amount > 0 && amount < MIN_WITHDRAWAL_COINS) {
            inrValueText.innerText = `Error: Minimum is ${MIN_WITHDRAWAL_COINS} Coins.`;
            inrValueText.style.color = '#f44336';
        } else if (amount > window.coins) {
             inrValueText.innerText = `Error: Insufficient balance.`;
             inrValueText.style.color = '#f44336';
        }
    }
}

window.submitWithdrawal = () => {
    const amount = Number(document.getElementById('upiAmount').value);
    const upiId = document.getElementById('upiId').value.trim();

    if (amount < MIN_WITHDRAWAL_COINS || amount > window.coins) {
        alert(`Withdrawal failed: Amount must be between ${MIN_WITHDRAWAL_COINS} and ${window.coins}.`);
        return;
    }
    if (upiId.length < 5 || !upiId.includes('@')) {
        alert("Withdrawal failed: Please enter a valid UPI ID.");
        return;
    }

    window.coins -= amount;
    window.upiId = upiId; // Save UPI ID for next time

    window.updateDatabase({ coins: window.coins, upiId: window.upiId });

    const withdrawalRequest = {
        userId: STATIC_USER_ID,
        userName: document.getElementById('username').innerText,
        amount: amount,
        upiId: upiId,
        timestamp: Date.now(),
        status: 'Pending'
    };

    push(WITHDRAWALS_REF, withdrawalRequest).then(() => {
        closeWithdrawalModal();
        alert(`Withdrawal of ${amount} Coins (‚Çπ${(amount/1000).toFixed(2)}) to UPI ID ${upiId} submitted successfully. Coins deducted. Processing in 24 hours.`);
    }).catch(error => {
         alert("Withdrawal failed to submit. Please try again. Error: " + error.message);
         // Revert coin deduction if push fails
         window.coins += amount;
         window.updateDatabase({ coins: window.coins });
    });
}

window.onclick = function(event) {
    if (event.target == withdrawalModal) {
        window.closeWithdrawalModal();
    }
}

// --- REFERRAL FUNCTIONS ---

window.shareReferralLink = () => {
    const link = document.getElementById('refLink').innerText;
    const shareText = `üí∞ CoinMine ‡§Æ‡•á‡§Ç ‡§∂‡§æ‡§Æ‡§ø‡§≤ ‡§π‡•ã‡§Ç ‡§î‡§∞ ‡§ï‡§Æ‡§æ‡§®‡§æ ‡§∂‡•Å‡§∞‡•Ç ‡§ï‡§∞‡•á‡§Ç! ‡§Æ‡•á‡§∞‡§æ ‡§∞‡•á‡§´‡§∞‡§≤ ‡§≤‡§ø‡§Ç‡§ï ‡§â‡§™‡§Ø‡•ã‡§ó ‡§ï‡§∞‡•á‡§Ç: ${link}‡•§ ‡§Ü‡§™‡§ï‡•ã ‡§§‡•Å‡§∞‡§Ç‡§§ 700 Coin ‡§î‡§∞ ‡§Æ‡•á‡§∞‡•á ‡§¶‡•ç‡§µ‡§æ‡§∞‡§æ ‡§ï‡§Æ‡§æ‡§è ‡§ó‡§è Coins ‡§™‡§∞ 5% ‡§Ü‡§ú‡•Ä‡§µ‡§® ‡§ï‡§Æ‡•Ä‡§∂‡§® ‡§Æ‡§ø‡§≤‡•á‡§ó‡§æ!`;

    if (navigator.share) {
        navigator.share({
            title: 'CoinMine Referral',
            text: shareText,
            url: link,
        }).catch((error) => {
            console.log('Error sharing or cancelled, falling back to copy:', error);
            fallbackShare(shareText);
        });
    } else {
        fallbackShare(shareText);
    }
}

function fallbackShare(text) {
    navigator.clipboard.writeText(text).then(() => {
        alert("‡§∞‡•á‡§´‡§∞‡§≤ ‡§∏‡§Ç‡§¶‡•á‡§∂ ‡§î‡§∞ ‡§≤‡§ø‡§Ç‡§ï ‡§∏‡§´‡§≤‡§§‡§æ‡§™‡•Ç‡§∞‡•ç‡§µ‡§ï ‡§ï‡•â‡§™‡•Ä ‡§ï‡§∞ ‡§≤‡§ø‡§Ø‡§æ ‡§ó‡§Ø‡§æ ‡§π‡•à! ‡§á‡§∏‡•á ‡§∏‡§æ‡§ù‡§æ ‡§ï‡§∞‡•á‡§Ç‡•§");
    }).catch(err => {
        const textArea = document.createElement('textarea');
        textArea.value = text;
        document.body.appendChild(textArea);
        textArea.focus();
        textArea.select();
        try {
            document.execCommand('copy');
            alert("‡§∞‡•á‡§´‡§∞‡§≤ ‡§∏‡§Ç‡§¶‡•á‡§∂ ‡§î‡§∞ ‡§≤‡§ø‡§Ç‡§ï ‡§∏‡§´‡§≤‡§§‡§æ‡§™‡•Ç‡§∞‡•ç‡§µ‡§ï ‡§ï‡•â‡§™‡•Ä ‡§ï‡§∞ ‡§≤‡§ø‡§Ø‡§æ ‡§ó‡§Ø‡§æ ‡§π‡•à! ‡§á‡§∏‡•á ‡§∏‡§æ‡§ù‡§æ ‡§ï‡§∞‡•á‡§Ç‡•§");
        } catch (err) {
            alert('‡§ï‡•â‡§™‡•Ä ‡§®‡§π‡•Ä‡§Ç ‡§ï‡§ø‡§Ø‡§æ ‡§ú‡§æ ‡§∏‡§ï‡§æ‡•§ ‡§ï‡•É‡§™‡§Ø‡§æ ‡§¨‡•â‡§ï‡•ç‡§∏ ‡§∏‡•á ‡§≤‡§ø‡§Ç‡§ï ‡§Æ‡•à‡§®‡•ç‡§Ø‡•Å‡§Ö‡§≤ ‡§∞‡•Ç‡§™ ‡§∏‡•á ‡§ï‡•â‡§™‡•Ä ‡§ï‡§∞‡•á‡§Ç‡•§');
        }
        document.body.removeChild(textArea);
        console.error('Could not copy text: ', err);
    });
}


// --- INIT and NAVIGATION FUNCTIONS ---

document.addEventListener('DOMContentLoaded', () => {
    loadAdminSettings();
    loadUserData();
    loadLiveTasks();
    loadWithdrawalHistory();
});

window.showSection = (sectionId, button) => {
  document.querySelectorAll('.section').forEach(s=>s.style.display='none');
  document.getElementById(sectionId).style.display='block';
  document.querySelectorAll('.nav-btn').forEach(btn=>btn.classList.remove('active'));
  button.classList.add('active');
  // <<<--- SCROLL CORRECTION ADDED HERE --->>>
  window.scrollTo(0, 0);
}

window.showProfileDetails = () => {
    if (profileDetailsDiv.style.display === 'none' || profileDetailsDiv.style.display === '') {
        profileDetailsDiv.style.display = 'flex';
    } else {
        profileDetailsDiv.style.display = 'none';
    }
}

function fallbackCopyTextToClipboard(text) {
    const textArea = document.createElement('textarea');
    textArea.value = text;
    textArea.style.position = 'fixed';
    textArea.style.top = '0';
    textArea.style.left = '0';
    textArea.style.opacity = '0';
    document.body.appendChild(textArea);
    textArea.focus();
    textArea.select();
    try {
        const successful = document.execCommand('copy');
        document.body.removeChild(textArea);
        return successful;
    } catch (err) {
        document.body.removeChild(textArea);
        return false;
    }
}

window.copyUserId = async () => {
    const profileId = STATIC_USER_ID;
    const copyIcon = document.getElementById('copyIdIcon');
    const originalContent = copyIcon ? copyIcon.innerHTML : 'üìã'; // Handle null case for task button

    let copySuccessful = false;
    if (navigator.clipboard && navigator.clipboard.writeText) {
        try {
            await navigator.clipboard.writeText(profileId);
            copySuccessful = true;
        } catch (err) {
            console.error('Modern copy failed, attempting fallback:', err);
        }
    }

    if (!copySuccessful) {
        copySuccessful = fallbackCopyTextToClipboard(profileId);
    }

    if (copySuccessful) {
        if (copyIcon) {
            copyIcon.innerHTML = '‚úÖ';
            setTimeout(() => {
                copyIcon.innerHTML = originalContent;
            }, 1500);
        }
         alert(`‚úÖ User ID "${profileId}" Copied Successfully!`);
    } else {
        alert(`‚ùå Failed to copy. Please copy the ID manually: "${profileId}"`);
    }
}
window.showMsg = () => { alert('Notifications: Welcome to CoinMine!'); }

</script>

<!-- ================== GIFT SECTION SCRIPT ================== -->
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
<script>
    const giftFirebaseConfig = {
      apiKey: "AIzaSyCcgl31JqffVd8bW8G23UurFhxH8IFlEfM",
      authDomain: "mining-bot-276d0.firebaseapp.com",
      databaseURL: "https://mining-bot-276d0-default-rtdb.firebaseio.com",
      projectId: "mining-bot-276d0",
      storageBucket: "mining-bot-276d0.firebasestorage.app",
      messagingSenderId: "263688973305",
      appId: "1:263688973305:web:9346d02b16f8b386ec2b28",
      measurementId: "G-T38M420DC0"
    };

    // Initialize a separate Firebase app for the gift functionality
    const giftApp = firebase.initializeApp(giftFirebaseConfig, "giftApp");
    const giftDatabase = giftApp.database();

    let lastClickedButton = null;
    let claimSettings = {};
    let clientID = getClientID();

    function getClientID() {
      let id = localStorage.getItem('clientID');
      if (!id) {
        id = 'client-' + Math.random().toString(36).substring(2, 15)
          + Math.random().toString(36).substring(2, 15);
        localStorage.setItem('clientID', id);
      }
      return id;
    }

    async function checkClaimStatus() {
      const claimContainer = document.getElementById('claimButtonContainer');
      const redeemedMsg = document.getElementById('redeemedMessage');
      const claimCode = claimSettings.claim1 ? claimSettings.claim1.code : null;
      if (!claimCode) return;

      const snapshot = await giftDatabase.ref('redemptions_by_user/' + clientID).once('value');
      const userRedemptions = snapshot.val();

      let claimRedeemed = false;
      if (userRedemptions) {
        for (const key in userRedemptions) {
          if (userRedemptions[key].code === claimCode) {
            claimRedeemed = true;
            break;
          }
        }
      }

      claimContainer.style.display = claimRedeemed ? 'none' : 'block';
      redeemedMsg.style.display = claimRedeemed ? 'block' : 'none';
    }

    function loadClaimSettings() {
      giftDatabase.ref('claim_settings').once('value', (snapshot) => {
        claimSettings = snapshot.val() || {};
        const btn = document.getElementById('claimBtn1');
        const setting = claimSettings.claim1;

        if (setting && setting.url) {
          btn.onclick = function() { claimCode(this, setting.url); };
        } else {
          btn.onclick = function() { claimCode(this, 'placeholder'); };
        }
        checkClaimStatus();
      });
    }

    // Load claim settings when the gift section becomes visible
    document.addEventListener('DOMContentLoaded', () => {
        const giftSection = document.getElementById('gift');
        const observer = new MutationObserver(mutations => {
            mutations.forEach(mutation => {
                if (mutation.attributeName === 'style' && giftSection.style.display === 'block') {
                    loadClaimSettings();
                }
            });
        });
        observer.observe(giftSection, { attributes: true });
    });


    async function redeemCode() {
      let code = document.getElementById("giftCode").value.trim().toUpperCase();
      if (code === "") {
        alert("Please enter a gift code!");
        return;
      }

      try {
        let codeData = null;
        const setting1 = claimSettings.claim1;
        if (setting1 && setting1.code === code) codeData = setting1;
        if (!codeData && claimSettings.common && claimSettings.common.code === code)
          codeData = claimSettings.common;

        if (!codeData) {
          alert("Invalid Gift Code! Please enter a correct code.");
          return;
        }

        const redemptionSnapshot = await giftDatabase.ref('redemptions_by_user/' + clientID).once('value');
        const userRedemptions = redemptionSnapshot.val();

        let alreadyRedeemed = false;
        if (userRedemptions) {
          for (const key in userRedemptions) {
            if (userRedemptions[key].code === code) {
              alreadyRedeemed = true;
              break;
            }
          }
        }

        if (alreadyRedeemed) {
          alert("You have already redeemed the code '" + code + "'. Each code can be redeemed only once.");
          return;
        }

        const coinsAwarded = codeData.coins;
        const timestamp = new Date().toISOString();
        const redemptionData = {
          code, coins: coinsAwarded, redeemedAt: timestamp, clientID
        };

        await giftDatabase.ref('redeemed_codes').push(redemptionData);
        await giftDatabase.ref('redemptions_by_user/' + clientID).push({ code, coins: coinsAwarded });

        // <<<--- 1. ADD COINS TO THE MAIN APP'S BALANCE --->>>
        if (window.coins !== undefined && typeof window.updateDatabase === 'function') {
            window.coins += coinsAwarded;
            window.updateDatabase({ coins: window.coins });
            alert("Code '" + code + "' successfully redeemed! üéâ\nYou won " + coinsAwarded + " coins and they have been added to your balance!");
        } else {
            alert("Code '" + code + "' successfully redeemed! üéâ\nYou won " + coinsAwarded + " coins!");
            console.warn('Main app coin balance or update function not found.');
        }
        
        // <<<--- 2. HIDE THE CLAIM BUTTON AFTER REDEEMING --->>>
        document.getElementById('claimButtonContainer').style.display = 'none';

        document.getElementById("giftCode").value = "";
        if (code === setting1?.code) checkClaimStatus();

      } catch (error) {
        console.error("Redemption Error:", error);
        alert("Redemption failed! Please try again later. (Error: " + error.message + ")");
      }
    }

    function claimCode(button, url) {
      if (!url || url === 'placeholder') {
        alert("Admin has not set this claim link yet! Please wait.");
        return;
      }
      lastClickedButton = button;
      window.location.href = url;
    }
</script>
</body>
</html>
