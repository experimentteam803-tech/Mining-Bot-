<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CoinMine App - Telegram Mini App</title>
<style>
/* Basic Reset and Global Styles */
*{margin:0;padding:0;box-sizing:border-box;font-family:'Poppins', sans-serif}
body{
  background:linear-gradient(180deg,#000000,#141e30);
  color:white;
  min-height:100vh;
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:flex-start;
}
/* Header (Navigation Bar) */
header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  width:100%;
  padding:15px 20px;
  background:rgba(0,0,0,0.8);
  box-shadow:0 2px 8px rgba(0,0,0,0.6);
  position:fixed;
  top:0;
  z-index:100;
}
header .profile{cursor:pointer;display:flex;align-items:center;gap:10px}
header .profile img{width:45px;height:45px;border-radius:50%;border:2px solid #32cd32}
header .profile span{font-weight:600;color:#90ee90}
header .msg-icon{cursor:pointer;font-size:26px;color:#32cd32}

/* Main Content Area */
main{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:flex-start;
  width:100%;
  padding-top:70px;
  padding-bottom: 90px;
}
.section{display:none;width:100%;padding:20px;animation:fadeIn 0.3s ease;}
#home{display:block;}

/* Home Section Styles (Mining) */
#home h2{font-size:24px;margin-bottom:5px;color:#90ee90;text-align: center;}
#totalCoins{font-size:48px;color:#ffd700;font-weight:700;margin-bottom:40px;text-shadow: 0 0 10px rgba(255, 215, 0, 0.5);text-align: center;}
.circle-container{position:relative;display:flex;align-items:center;justify-content:center;width: 100%;margin-top: 20px;}
.circle {width:280px; height:280px; border-radius:50%; background: #0d0d0d; display:flex; align-items:center; justify-content:center; position: relative; cursor:pointer; overflow:hidden; box-shadow: inset 0 0 50px rgba(50, 205, 50, 0.5), 0 0 60px rgba(50, 205, 50, 0.8), 0 0 100px rgba(50, 205, 50, 0.4); transition: box-shadow 0.3s ease-out;}
.circle span{font-size:32px; font-weight:700; color: #ffdd57; z-index:10;}
.circle.mining-active-glow {animation: pulseGlow 2s infinite alternate;}
@keyframes pulseGlow {
    0% {box-shadow: inset 0 0 50px rgba(50, 205, 50, 0.5), 0 0 60px rgba(50, 205, 50, 0.8), 0 0 100px rgba(50, 205, 50, 0.4);}
    100% {box-shadow: inset 0 0 70px rgba(0, 255, 0, 0.7), 0 0 80px rgba(0, 255, 0, 1), 0 0 120px rgba(0, 255, 0, 0.6);}
}
.mining-animation {position:absolute;width:18px;height:18px;background: gold;border-radius:50%;animation:mineAnim 1.5s linear forwards;}
@keyframes mineAnim {0%{transform: translate(0,0) scale(1);opacity:1;}50%{transform: translate(0,-100px) scale(1.5);opacity:0.7;}100%{transform: translate(0,0) scale(1);opacity:0;}}
/* Common button style for mine and watch ad */
button.action-btn{padding:14px 28px;border-radius:30px;font-weight:700;font-size:18px;cursor:pointer;margin-top:20px;transition:0.3s;display: block; margin-left: auto; margin-right: auto; border: none;}
button.action-btn:hover:enabled{filter: brightness(1.1);}
button.action-btn:disabled{cursor: not-allowed; opacity: 0.7;}

/* Specific button styles */
.mine-btn {
    background: #32cd32;
    color: #000;
    box-shadow: 0 4px 15px rgba(50, 205, 50, 0.5);
    margin-top: 40px; /* Space above mine button */
}
.ad-btn {
    background: #ffd700;
    color: #000;
    box-shadow: 0 4px 15px rgba(255, 215, 0, 0.5);
}

#miningCountdown {color: #90ee90; font-size: 18px; margin-top: 10px; font-weight: 600; text-align: center;}
#adStatus {color: #ffd700; font-size: 16px; margin-top: 10px; font-weight: 600; text-align: center;}

.wallet-summary {
    background: #282828;
    padding: 20px;
    border-radius: 10px;
    margin: 20px 0;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
    text-align: center;
}
.balance-info { margin-bottom: 20px; }
.balance-label { font-size: 14px; color: #aaa; }
.balance-value { font-size: 36px; font-weight: 700; color: #ffd700; }
.value-inr { font-size: 16px; color: #90ee90; margin-top: 5px; }
.wallet-summary button {
    background: #32cd32;
    color: #000;
    padding: 10px 20px;
    border: none;
    border-radius: 20px;
    font-weight: 600;
    cursor: pointer;
    transition: 0.3s;
}
.withdrawal-note { font-size: 12px; color: #aaa; margin-top: 15px; }
.referral-box {
    background: #282828;
    padding: 15px;
    border-radius: 8px;
    margin-bottom: 20px;
    border: 1px dashed #32cd32;
    text-align: center;
}
#refLink {
    font-size: 14px;
    color: #ffd700;
    word-break: break-all;
    margin-top: 5px;
}
.referral-details {
    padding: 15px;
    background: #1c1c1c;
    border-radius: 8px;
    margin-bottom: 20px;
}
.referral-instruction-list {
    list-style: none;
    padding-left: 0;
    text-align: left;
}
.referral-instruction-list li {
    margin-bottom: 10px;
    font-size: 15px;
    color: #ccc;
    padding-left: 20px;
    position: relative;
}
.referral-instruction-list li::before {
    content: '‚òÖ';
    color: #ffd700;
    font-weight: bold;
    display: inline-block;
    width: 1em;
    margin-left: -1em;
}
.share-btn {
    background: #ffd700;
    color: #000;
    padding: 12px 25px;
    border: none;
    border-radius: 25px;
    font-weight: 700;
    cursor: pointer;
    transition: 0.3s;
    width: 80%;
}


/* Modal Styles for Withdrawal */
.modal { display: none; position: fixed; z-index: 200; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.8); padding-top: 100px;}
.modal-content { background: #282828; margin: 5% auto; padding: 30px; border-radius: 15px; width: 90%; max-width: 400px; position: relative; color: white; box-shadow: 0 8px 30px rgba(0, 0, 0, 0.7);}
.close-btn { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer;}
.withdraw-button { width: 100%; padding: 12px; background: #ffd700; color: #000; font-weight: 700; border: none; border-radius: 8px; margin-top: 15px; cursor: pointer; transition: 0.3s;}
.form-group { margin-bottom: 15px; text-align: left; }
.form-group label { display: block; margin-bottom: 5px; font-weight: 600; color: #90ee90; }
.form-group input { width: 100%; padding: 10px; border: 1px solid #555; border-radius: 5px; background: #1c1c1c; color: white; }

/* Footer Navigation Bar */
.navbar{display:flex;justify-content:space-around;background:rgba(0,0,0,0.9);padding:15px 0;border-top:2px solid #32cd32;position:fixed;bottom:0;width:100%;z-index:100;}
.nav-btn{background:none;border:none;color:white;font-size:18px;padding:8px 12px;border-radius:10px;cursor:pointer;transition:0.2s;font-weight:600;}
.nav-btn.active,.nav-btn:hover{color:#32cd32;background:rgba(50, 205, 50, 0.2);}

@keyframes fadeIn{from{opacity:0;}to{opacity:1;}}

/* --- NEW STYLES FOR GIFT SECTION --- */
#gift .gift-container {
    background: #1c1c1c;
    padding: 30px;
    border-radius: 12px;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
    text-align: center;
    width: 100%;
    max-width: 420px;
    border: 1px solid #333;
    margin: 0 auto;
}
#gift h2 {
    margin-top: 0;
    margin-bottom: 5px;
    color: #90ee90; /* Light Green */
    font-weight: 700;
    font-size: 1.8em;
}
#gift .sub-text {
    font-size: 0.9em;
    color: #aaa;
    margin-bottom: 5px;
    font-weight: 500;
}
#gift .highlight {
    font-size: 1em;
    color: #fff;
    margin-bottom: 20px;
    font-weight: 600;
    padding: 10px 5px;
    border-bottom: 1px solid #333;
    border-top: 1px solid #333;
    background: rgba(255, 215, 0, 0.1); /* Faint yellow background */
}
#gift .highlight span {
    color: #ffd700; /* Gold color for numbers */
}
#gift input {
    width: 100%;
    padding: 15px;
    border: 2px solid #555;
    border-radius: 8px;
    margin-bottom: 20px;
    font-size: 1em;
    background: #282828;
    color: white;
    box-sizing: border-box;
    transition: border-color 0.3s;
    text-align: center;
    text-transform: uppercase;
}
#gift input:focus {
    border-color: #ffd700;
    outline: none;
    box-shadow: 0 0 0 3px rgba(255, 215, 0, 0.25);
}
#gift button {
    width: 100%;
    padding: 15px;
    border: none;
    border-radius: 8px;
    font-size: 1em;
    font-weight: 700;
    cursor: pointer;
    transition: all 0.3s ease;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: 15px;
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
}
#gift .redeem-btn {
    background: #32cd32; /* Green */
    color: #000;
    box-shadow: 0 5px 15px rgba(50, 205, 50, 0.3);
}
#gift .redeem-btn:hover {
    filter: brightness(1.1);
    transform: translateY(-2px);
}
#gift .claim-btn {
    background: #ffd700; /* Yellow */
    color: #000;
    margin-bottom: 0 !important;
    box-shadow: 0 5px 15px rgba(255, 215, 0, 0.3);
}
#gift .claim-btn:hover {
    filter: brightness(1.1);
    transform: translateY(-2px);
}
#gift p.separator {
    color: #888;
    font-weight: 500;
    font-size: 0.9em;
    margin: 15px 0;
}
#gift .note {
    margin-top: 20px;
    font-size: 0.9em;
    color: #90ee90;
    padding-top: 15px;
    border-top: 1px dashed #444;
    font-weight: 500;
}
#gift #claimButtonContainer {
    display: block;
}
#gift .redeemed-message {
    display: none;
    padding: 15px;
    border-radius: 8px;
    background: #32cd32;
    color: #000;
    font-weight: 700;
    text-align: center;
    margin-bottom: 20px;
    font-size: 1.1em;
    box-shadow: 0 4px 10px rgba(50, 205, 50, 0.3);
    letter-spacing: 0.3px;
}

/* --- NEW STYLES FOR WITHDRAWAL HISTORY --- */
.history-container {
    margin-top: 30px;
    background: #1c1c1c;
    padding: 20px;
    border-radius: 10px;
}
.history-container h3 {
    text-align: center;
    color: #ffd700;
    margin-bottom: 15px;
}
.history-table {
    width: 100%;
    border-collapse: collapse;
}
.history-table th, .history-table td {
    padding: 10px;
    text-align: left;
    border-bottom: 1px solid #333;
}
.history-table th {
    font-size: 14px;
    color: #aaa;
}
.history-table td {
    font-size: 15px;
}
.status-pending { color: #ffd700; font-weight: 600; }
.status-approved { color: #32cd32; font-weight: 600; }
.status-rejected { color: #f44336; font-weight: 600; }

</style>
<script src="https://telegram.org/js/telegram-web-app.js"></script>

</head>
<body>

<div id="app-content" style="width: 100%;">
    <header>
    <div class="profile" onclick="showProfile()">
    <img id="profile-img" src="https://i.pravatar.cc/45" alt="Profile">
    <span id="username">Loading...</span> </div>
    <div class="msg-icon" onclick="showMsg()">üí¨</div>
    </header>
    <main>
    <section id="home" class="section">
    <div id="totalCoins"><span id="coinCount">0</span></div>
    <h2>Your Coins</h2>

    <div class="circle-container">
    <div class="circle" id="mineCircle">
    <span id="coinInsideCircle">0</span>
    </div>
    </div>

    <button class="action-btn ad-btn" id="watchAdBtn" onclick="watchAd()">üé¨ Watch Ad</button>
    <div id="adStatus">Ads Watched: 0/10</div>

    <button class="action-btn mine-btn" id="mineBtn" onclick="startDailyMining()">ü™ô Start Mining</button>
    <div id="miningCountdown">Click to start 1 hour session</div>
    </section>

    <section id="task" class="section">
        <div id="taskList">
            <div class="task-notice" style="background: #2a2a2a; border-left: 4px solid #ffd700; padding: 15px; border-radius: 8px; margin: 0 0 25px 0;">
                <h4 style="color: #ffd700; margin-bottom: 10px;">After Completing a Task:</h4>
                <p style="font-size: 14px; color: #ccc; line-height: 1.6;">
                    Please send your <strong>User ID</strong> and the <strong>Task Name</strong> to our Customer Service Team for quick verification and reward processing.
                </p>
                <div class="user-id-actions" style="margin-top: 15px; display: flex; align-items: center; justify-content: space-between; gap: 10px; flex-wrap: wrap;">
                    <div style="background: #1c1c1c; padding: 8px 12px; border-radius: 6px; font-size: 14px;">
                        Your User ID: <span id="taskUserId" style="font-weight: bold; color: #90ee90;"></span>
                    </div>
                    <div>
                        <button onclick="copyUserId()" style="background: #555; color: white; border: none; padding: 8px 15px; border-radius: 6px; cursor: pointer; font-weight: 600;">üìã Copy UID</button>
                        <a href="https://t.me/MiningFatherhelp " target="_blank" style="background: #32cd32; color: #000; text-decoration: none; padding: 8px 15px; border-radius: 6px; font-weight: 600;">‚úâÔ∏è Send Msg</a>
                    </div>
                </div>
            </div>
            
            <h2 style="text-align: center;">üß© Daily Tasks</h2>
            <p style="margin-bottom: 20px; color:#aaa; text-align: center;">Complete simple tasks and earn rewards.</p>
            
            <!-- This container will be filled by the loadLiveTasks function -->
            <div id="task-items-container">
                <p style="text-align: center; color: #777; margin-top: 50px;">Loading tasks...</p>
            </div>

        </div>
    </section>
    <section id="wallet" class="section">
        <h2 style="text-align: center;">üíº Wallet</h2>
        <div class="wallet-summary">
            <div class="balance-info">
                <div class="balance-label">Current Balance (Coins)</div>
                <div class="balance-value"><span id="walletCoins">0</span></div>
                <div class="value-inr">‚Çπ <span id="walletValue">0.00</span> (1000 Coins ‚âà ‚Çπ1)</div>
            </div>
            <button onclick="showWithdrawalModal()">UPI Withdrawal</button>
            <div class="withdrawal-note">
                Minimum withdrawal amount is **10,000 Coins** (‚Çπ10.00).
            </div>
        </div>

        <!-- --- NEW WITHDRAWAL HISTORY SECTION --- -->
        <div class="history-container">
            <h3>Withdrawal History</h3>
            <div style="max-height: 300px; overflow-y: auto;">
                <table class="history-table">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Amount</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="withdrawal-history-table">
                        <!-- History rows will be inserted here -->
                    </tbody>
                </table>
            </div>
        </div>
    </section>
    <section id="referral" class="section">
        <h2 style="text-align: center;">üîó Referral Program</h2>
        <div id="referral-content">
            <p style="text-align: center; color: #ccc; margin-bottom: 25px;">Invite your friends to CoinMine and earn substantial rewards!</p>
            
            <div class="referral-box">
                <div style="font-size: 16px; color: #90ee90; font-weight: 600;">Your Unique Referral Link:</div>
                <p id="refLink">Loading...</p> 
            </div>

            <div class="referral-details">
                <h3 style="color: #fff; margin-bottom: 15px;">How It Works:</h3>
                <ul class="referral-instruction-list">
                    <li><strong>Share:</strong> Share your unique link with friends and family.</li>
                    <li><strong>Signup Bonus:</strong> You earn **700 Coins** immediately when your friend successfully signs up using your link.</li>
                    <li><strong>Lifetime Commission:</strong> You earn a **5% commission** on all coins your referred users mine, forever!</li>
                </ul>
                <p style="text-align: center; color: #ffd700; font-weight: 600; margin-bottom: 20px;">The more you share, the more you earn!</p>
            </div>

            <button class="share-btn" onclick="shareReferralLink()">
                üì¢ Share My Link Now
            </button>
        </div>
    </section>

    <section id="gift" class="section">
        <div class="gift-container">
            <h2><span style="color: #FFD700;">‚òÖ</span> Redeem Gift Code</h2>
            <p class="sub-text">A new gift code may be available periodically.</p>
            <p class="highlight">You can win up to <span>10,000</span> coins from gift codes!</p>
        
            <input type="text" id="giftCode" placeholder="Enter your gift code here">
            <button class="redeem-btn" onclick="redeemCode()">Redeem Code</button>
            <p class="separator">‚Äî OR GET A FREE CODE ‚Äî</p>
        
            <div id="claimButtonContainer">
              <button class="claim-btn" id="claimBtn1" onclick="claimCode(this, 'placeholder')">
                Claim Free Gift Code üöÄ
              </button>
            </div>
        
            <div id="redeemedMessage" class="redeemed-message">
              This special code has already been redeemed! ‚úÖ
            </div>
        
            <p class="note">Claim a code and redeem it to earn bonus coins üí∞</p>
        </div>
    </section>

    </main>
    <nav class="navbar">
    <button class="nav-btn active" onclick="showSection('home', this)">üè† Home</button>
    <button class="nav-btn" onclick="showSection('task', this)">üß© Task</button>
    <button class="nav-btn" onclick="showSection('gift', this)">üéÅ Gift</button>
    <button class="nav-btn" onclick="showSection('wallet', this)">üíº Wallet</button>
    <button class="nav-btn" onclick="showSection('referral', this)">üîó Referral</button>
    </nav>
</div>


<div id="withdrawalModal" class="modal">
    <div class="modal-content">
        <span class="close-btn" onclick="closeWithdrawalModal()">&times;</span>
        <h3>UPI Withdrawal</h3>
        <p style="color:#aaa; text-align: center; margin-bottom: 15px;">Minimum: 10,000 Coins (‚Çπ10.00)</p>

        <div class="form-group">
            <label for="upiAmount">Coins to Withdraw:</label>
            <input type="number" id="upiAmount" placeholder="Min 10000" oninput="checkWithdrawalEligibility()">
            <small id="inrValueText" style="color: #90ee90;"></small>
        </div>
        <div class="form-group">
            <label for="upiId">Your UPI ID:</label>
            <input type="text" id="upiId" placeholder="example@bankupi">
        </div>
        <button class="withdraw-button" id="submitWithdrawalBtn" disabled onclick="submitWithdrawal()">Submit Withdrawal Request</button>
        <small style="display: block; text-align: center; color: #f44336; margin-top: 10px;">Withdrawals processed within 24 hours.</small>
    </div>
</div>

<script type="module">
// --- FIREBASE IMPORTS (ADDED QUERY FUNCTIONS) ---
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getAnalytics } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-analytics.js";
import { getDatabase, ref, set, onValue, update, push, get, query, orderByChild, equalTo } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

// --- TELEGRAM MINI APP INITIALIZATION ---
const WebApp = window.Telegram.WebApp;
WebApp.ready();

const telegramUser = WebApp.initDataUnsafe.user;
if (!telegramUser || !telegramUser.id) {
    alert("Error: Could not get Telegram user data. Please open the app via Telegram.");
    throw new Error("Missing Telegram User ID");
}

const TELEGRAM_USER_ID = telegramUser.id.toString();
const USER_NAME = telegramUser.first_name + (telegramUser.last_name ? ' ' + telegramUser.last_name : '');

// Set UI elements with Telegram Data
document.getElementById('username').innerText = USER_NAME;
document.getElementById('refLink').innerText = `https://t.me/YourBot?start=${TELEGRAM_USER_ID}`;
// End of Telegram Init

// --- FIREBASE CONFIGURATION ---
const firebaseConfig = {
    apiKey: "AIzaSyCcgl31JqffVd8bW8G23UurFhxH8IFlEfM",
    authDomain: "mining-bot-276d0.firebaseapp.com",
    projectId: "mining-bot-276d0",
    storageBucket: "mining-bot-276d0.firebasestorage.app",
    messagingSenderId: "263688973305",
    appId: "1:263688973305:web:bf3eab880a03dde0ec2b28",
    measurementId: "G-2FWW2SVSLR"
};

const app = initializeApp(firebaseConfig);
const analytics = getAnalytics(app);
const database = getDatabase(app);

const DB_NODE_PATH = 'users/' + TELEGRAM_USER_ID; 

// --- GLOBAL REFERENCES ---
const ADMIN_SETTINGS_REF = ref(database, 'admin_settings');
const TASKS_REF = ref(database, 'tasks');
const WITHDRAWALS_REF = ref(database, 'withdrawals');
const CLAIM_SETTINGS_REF = ref(database, 'claim_settings');
const REDEEMED_CODES_REF = ref(database, 'redeemed_codes');

// --- GLOBAL VARIABLES & CONSTANTS ---
window.coins = 0; 
window.dailyMinedTimestamp = 0; 
window.miningEndTime = 0; 
window.adsWatched = 0;
window.adsWatchedTimestamp = 0;
window.dbRef = ref(database, DB_NODE_PATH); 

const MINING_RATE_MS = 1500;
const ONE_HOUR_MS = 60 * 60 * 1000;
const ONE_DAY_MS = 24 * 60 * 60 * 1000;
const MIN_WITHDRAWAL_COINS = 10000;
window.ADS_REQUIRED = 10;
window.AD_REWARD_COINS = 5;
window.miningAdLinks = []; 
let claimSettings = {};

// UI Elements 
const mineButton = document.getElementById('mineBtn');
const watchAdBtn = document.getElementById('watchAdBtn');
const adStatusDisplay = document.getElementById('adStatus');
const mineCircle = document.getElementById('mineCircle');
const countdownDisplay = document.getElementById('miningCountdown');
const withdrawalModal = document.getElementById('withdrawalModal');
const submitWithdrawalBtn = document.getElementById('submitWithdrawalBtn');


// --- FIREBASE DATA HANDLING FUNCTIONS ---

function loadUserData() {
    onValue(window.dbRef, (snapshot) => {
        const data = snapshot.val();
        
        if (!data) {
            const initialData = {
                coins: 0, dailyMinedTimestamp: 0, miningEndTime: 0, adsWatched: 0,
                adsWatchedTimestamp: 0, upiId: '', telegramId: TELEGRAM_USER_ID,
                userName: USER_NAME, lastActive: Date.now()
            };
            set(window.dbRef, initialData);
            updateGlobalState(initialData);
            return;
        }

        update(window.dbRef, { lastActive: Date.now(), userName: USER_NAME });
        updateGlobalState(data);
        processDataForStateUpdate();
    }, (error) => {
        console.error("Firebase Read Error (User Data):", error);
        WebApp.showAlert("Failed to load user data.");
    });
}

function loadAdminSettings() {
    onValue(ADMIN_SETTINGS_REF, (snapshot) => {
        const settings = snapshot.val();
        if (settings) {
            window.ADS_REQUIRED = settings.miningAds?.required || 10;
            
            if (settings.miningAds?.links && Array.isArray(settings.miningAds.links)) {
                window.miningAdLinks = settings.miningAds.links;
            } else {
                window.miningAdLinks = [];
            }

            window.AD_REWARD_COINS = settings.adTasks?.reward || 5;
            updateMiningButtonState();
            updateAdStatus();
        }
    }, (error) => console.error("Firebase Read Error (Admin Settings):", error));
}

// --- TASK SYSTEM FIXED ---
function loadLiveTasks() {
    const taskContainer = document.getElementById('task-items-container');
    onValue(TASKS_REF, (snapshot) => {
        taskContainer.innerHTML = ''; // Clear previous tasks
        const tasks = snapshot.val();
        let taskHtml = '';
        let activeTasksFound = false;

        if (tasks) {
            for (const taskId in tasks) {
                const task = tasks[taskId];
                if (task.active) {
                    activeTasksFound = true;
                    taskHtml += `
                        <div class="referral-details" style="border-left: 5px solid #ffd700; padding: 15px; margin-bottom: 15px; background: #1c1c1c;">
                            <h3 style="color: #90ee90; margin-bottom: 5px;">${task.name}</h3>
                            <p style="color: #fff; font-weight: 600;">Reward: <span style="color: #ffd700;">${task.reward.toLocaleString()} Coins</span></p>
                            <p style="font-size: 14px; color: #ccc; margin-top: 10px;">Instructions:</p>
                            <ul class="referral-instruction-list" style="margin-bottom: 15px;">
                                ${task.instructions.map(inst => `<li>${inst}</li>`).join('')}
                            </ul>
                            <a href="${task.link}" target="_blank" style="text-decoration: none;">
                                <button class="action-btn ad-btn" style="width: 100%; margin: 0; background: #32cd32; color: #000;">
                                    ${task.logoUrl ? `<img src="${task.logoUrl}" style="width: 20px; height: 20px; margin-right: 5px; vertical-align: middle;">` : ''}
                                    Complete Task
                                </button>
                            </a>
                        </div>
                    `;
                }
            }
        }
        
        if (activeTasksFound) {
            taskContainer.innerHTML = taskHtml;
        } else {
            taskContainer.innerHTML = '<p style="text-align: center; color: #777; margin-top: 50px;">No tasks available right now. Check back later!</p>';
        }
    });
}

// --- NEW FUNCTION TO LOAD WITHDRAWAL HISTORY ---
function loadWithdrawalHistory() {
    const historyTableBody = document.getElementById('withdrawal-history-table');
    const userWithdrawalsQuery = query(WITHDRAWALS_REF, orderByChild('userId'), equalTo(TELEGRAM_USER_ID));

    onValue(userWithdrawalsQuery, (snapshot) => {
        historyTableBody.innerHTML = ''; // Clear old data

        if (!snapshot.exists()) {
            historyTableBody.innerHTML = `<tr><td colspan="3" style="text-align:center; color: #888;">No history found.</td></tr>`;
            return;
        }

        const withdrawals = [];
        snapshot.forEach(childSnapshot => {
            withdrawals.push(childSnapshot.val());
        });

        // Sort by newest first
        withdrawals.sort((a, b) => b.timestamp - a.timestamp);

        withdrawals.forEach(data => {
            const date = new Date(data.timestamp).toLocaleDateString();
            const statusClass = `status-${data.status.toLowerCase()}`;
            const row = `
                <tr>
                    <td>${date}</td>
                    <td>${data.amount.toLocaleString()}</td>
                    <td class="${statusClass}">${data.status}</td>
                </tr>
            `;
            historyTableBody.innerHTML += row;
        });
    });
}


function updateGlobalState(data) {
    window.coins = data.coins || 0;
    window.dailyMinedTimestamp = data.dailyMinedTimestamp || 0;
    window.miningEndTime = data.miningEndTime || 0;
    window.adsWatched = data.adsWatched || 0;
    window.adsWatchedTimestamp = data.adsWatchedTimestamp || 0;
    window.upiId = data.upiId || '';
}

function processDataForStateUpdate() {
    if (window.miningEndTime !== 0 && window.miningEndTime <= Date.now()) {
        stopMining(false); 
    }

    if (window.dailyMinedTimestamp !== 0 && window.canMineToday()) {
        updateDatabase({ dailyMinedTimestamp: 0, adsWatched: 0, adsWatchedTimestamp: 0 });
        window.dailyMinedTimestamp = 0;
        window.adsWatched = 0;
        window.adsWatchedTimestamp = 0;
    }

    updateCoinDisplays();
    updateMiningButtonState();
}

window.updateDatabase = (updates) => {
    update(window.dbRef, updates)
        .catch(error => console.error("Database Write Error:", error));
};


// --- HELPER FUNCTIONS ---
function updateCoinDisplays() {
    const inrValue = (window.coins / 1000).toFixed(2);
    const coinsStr = Math.floor(window.coins).toLocaleString();
    document.getElementById('coinCount').innerText = coinsStr;
    document.getElementById('coinInsideCircle').innerText = coinsStr;
    document.getElementById('walletCoins').innerText = coinsStr;
    document.getElementById('walletValue').innerText = inrValue;
}

function formatTime(ms) {
    if (ms < 0) ms = 0;
    const seconds = Math.floor((ms / 1000) % 60);
    const minutes = Math.floor((ms / (1000 * 60)) % 60);
    const hours = Math.floor((ms / (1000 * 60 * 60)) % 24);
    return `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
}

window.canMineToday = () => {
  return (Date.now() - window.dailyMinedTimestamp) >= ONE_DAY_MS;
}


// --- AD-BASED MINING LOGIC ---
// <<<<<<<<<<<<< ‡§∏‡§ø‡§∞‡•ç‡§´ ‡§Ø‡§π ‡§´‡§Ç‡§ï‡•ç‡§∂‡§® ‡§¨‡§¶‡§≤‡§æ ‡§ó‡§Ø‡§æ ‡§π‡•à
window.watchAd = () => {
    const miningStillActive = window.miningEndTime > Date.now(); 
    const isInCooldown = !window.canMineToday() && window.dailyMinedTimestamp !== 0; 

    if (window.adsWatched >= window.ADS_REQUIRED) {
        WebApp.showAlert(window.canMineToday() ? "A new session is ready. Click 'Start Mining'." : "Ads are complete. Wait for the 24h reset.");
        return;
    }
    if (miningStillActive || isInCooldown) {
        WebApp.showAlert("Cannot watch ads while mining or in cooldown.");
        return;
    }

    if (window.miningAdLinks && window.miningAdLinks.length > 0) {
        const randomIndex = Math.floor(Math.random() * window.miningAdLinks.length);
        const adLink = window.miningAdLinks[randomIndex];
        WebApp.openLink(adLink);
    } 

    watchAdBtn.disabled = true;
    
    // ‡§¨‡§ü‡§® ‡§™‡§∞ 15 ‡§∏‡•á‡§ï‡§Ç‡§° ‡§ï‡§æ ‡§ï‡§æ‡§â‡§Ç‡§ü‡§°‡§æ‡§â‡§® ‡§¶‡§ø‡§ñ‡§æ‡§è‡§Ç
    let countdown = 15;
    watchAdBtn.innerText = `üé• Ad Playing... (${countdown}s)`;
    const interval = setInterval(() => {
        countdown--;
        if (countdown > 0) {
            watchAdBtn.innerText = `üé• Ad Playing... (${countdown}s)`;
        } else {
            clearInterval(interval);
        }
    }, 1000);

    // ‡§á‡§®‡§æ‡§Æ 15 ‡§∏‡•á‡§ï‡§Ç‡§° ‡§ï‡•á ‡§¨‡§æ‡§¶ ‡§¶‡•á‡§Ç
    setTimeout(() => {
        clearInterval(interval); // ‡§∏‡•Å‡§®‡§ø‡§∂‡•ç‡§ö‡§ø‡§§ ‡§ï‡§∞‡•á‡§Ç ‡§ï‡§ø ‡§á‡§Ç‡§ü‡§∞‡§µ‡§≤ ‡§¨‡§Ç‡§¶ ‡§π‡•ã ‡§ó‡§Ø‡§æ ‡§π‡•à
        window.adsWatched++;
        window.coins += window.AD_REWARD_COINS; 
        
        window.updateDatabase({ coins: window.coins, adsWatched: window.adsWatched, adsWatchedTimestamp: Date.now() });
        
        if (window.adsWatched < window.ADS_REQUIRED) {
            watchAdBtn.disabled = false;
            watchAdBtn.innerText = 'üé¨ Watch Ad';
            WebApp.showPopup({message: `+${window.AD_REWARD_COINS} Coins! ${window.ADS_REQUIRED - window.adsWatched} more ads needed.`});
        } else {
            watchAdBtn.innerText = '‚úÖ Ads Complete';
            WebApp.showPopup({message: `Congratulations! You can now start mining!`});
        }
    }, 15000); // <<<<<<<<<<<<< ‡§∏‡§Æ‡§Ø 15000ms (15 ‡§∏‡•á‡§ï‡§Ç‡§°) ‡§™‡§∞ ‡§∏‡•á‡§ü
}
// >>>>>>>>>>>>> ‡§¨‡§¶‡§≤‡§æ‡§µ ‡§Ø‡§π‡§æ‡§Å ‡§ñ‡§§‡•ç‡§Æ ‡§π‡•ã‡§§‡§æ ‡§π‡•à


function updateAdStatus() {
    const isInCooldown = !window.canMineToday() && window.dailyMinedTimestamp !== 0; 
    
    if (window.adsWatched >= window.ADS_REQUIRED) {
        adStatusDisplay.innerText = `Ads Complete! Mining unlocked.`;
        watchAdBtn.disabled = true;
        watchAdBtn.innerText = '‚úÖ Ads Complete';
        if (isInCooldown) {
            const remainingCooldown = (window.dailyMinedTimestamp + ONE_DAY_MS) - Date.now();
            adStatusDisplay.innerHTML = `Ads/Mining Reset in: ${formatTime(remainingCooldown)}`;
        }
    } else {
        adStatusDisplay.innerText = `Ads Watched: ${window.adsWatched}/${window.ADS_REQUIRED}`;
        watchAdBtn.disabled = isInCooldown; 
        watchAdBtn.innerText = 'üé¨ Watch Ad';
    }
}

// --- MINING FUNCTIONS ---
function startMiningAnimation(){
  const numParticles = Math.floor(Math.random() * 5) + 4; 
  for(let i=0;i<numParticles;i++){
    const anim=document.createElement('div');
    anim.className='mining-animation';
    anim.style.left=Math.random()*280+'px'; 
    anim.style.top=Math.random()*280+'px';
    mineCircle.appendChild(anim);
    setTimeout(()=>mineCircle.removeChild(anim), MINING_RATE_MS); 
  }
}

window.stopMining = (doUpdateState = true) => {
    if (window.miningInterval) clearInterval(window.miningInterval);
    if (window.remainingTimeInterval) clearInterval(window.remainingTimeInterval);
    window.miningInterval = null; window.remainingTimeInterval = null;
    mineCircle.classList.remove('mining-active-glow');
    window.miningEndTime = 0;
    window.updateDatabase({ miningEndTime: 0 }); 
    if (doUpdateState) updateMiningButtonState(); 
}

function updateCountdown() {
    const remainingSessionTime = window.miningEndTime - Date.now();
    if (remainingSessionTime <= 0) {
        window.stopMining();
        return;
    }
    mineCircle.classList.add('mining-active-glow');
    mineButton.disabled = true;
    mineButton.innerText = '‚õèÔ∏è Mining Active';
    mineButton.style.background = '#808080';
    countdownDisplay.innerText = 'Time Left: ' + formatTime(remainingSessionTime);
}

window.startDailyMining = () => {
  if (window.adsWatched < window.ADS_REQUIRED) {
      WebApp.showAlert(`Please watch ${window.ADS_REQUIRED} ads to start mining.`);
      return;
  }
  if (window.miningInterval) return; 
  if (!window.canMineToday()){
    startCooldownCountdown();
    return;
  }
  
  const currentTime = Date.now();
  const endTime = currentTime + ONE_HOUR_MS;
  
  window.dailyMinedTimestamp = currentTime; 
  window.miningEndTime = endTime; 
  window.updateDatabase({ dailyMinedTimestamp: currentTime, miningEndTime: endTime });

  window.miningInterval = setInterval(()=>{
    window.coins+=1;
    if (window.coins % 10 === 0) { window.updateDatabase({ coins: window.coins }); }
    startMiningAnimation();
    updateCoinDisplays();
  }, MINING_RATE_MS); 

  window.remainingTimeInterval = setInterval(updateCountdown, 1000); 
  setTimeout(window.stopMining, ONE_HOUR_MS);
  updateCountdown(); 
}

function startCooldownCountdown() {
    if (window.remainingTimeInterval) clearInterval(window.remainingTimeInterval);
    
    window.remainingTimeInterval = setInterval(() => {
        const remainingCooldown = (window.dailyMinedTimestamp + ONE_DAY_MS) - Date.now();
        if (remainingCooldown <= 0) {
            clearInterval(window.remainingTimeInterval);
            window.remainingTimeInterval = null;
            if (window.dailyMinedTimestamp !== 0) {
                 window.updateDatabase({ dailyMinedTimestamp: 0, adsWatched: 0, adsWatchedTimestamp: 0 });
            }
            updateMiningButtonState(); 
            return;
        }
        mineButton.disabled = true;
        mineButton.innerText = '‚è≥ Cooldown Active';
        mineButton.style.background = '#808080';
        countdownDisplay.innerText = 'Next Mine in: ' + formatTime(remainingCooldown);
        updateAdStatus(); 
    }, 1000);
}

function updateMiningButtonState() {
    const miningStillActive = window.miningEndTime > Date.now();
    const isAdsComplete = window.adsWatched >= window.ADS_REQUIRED;
    
    updateAdStatus(); 
    
    if (miningStillActive) {
        updateCountdown(); 
    } else if (!window.canMineToday() && window.dailyMinedTimestamp !== 0) {
        startCooldownCountdown();
    } else if (isAdsComplete) {
        if (window.miningInterval) clearInterval(window.miningInterval);
        if (window.remainingTimeInterval) clearInterval(window.remainingTimeInterval);
        mineCircle.classList.remove('mining-active-glow');
        mineButton.disabled = false;
        mineButton.innerText = 'ü™ô Start Mining';
        mineButton.style.background = '#32cd32';
        countdownDisplay.innerText = 'Click to start 1 hour session';
    } else {
        if (window.miningInterval) clearInterval(window.miningInterval);
        if (window.remainingTimeInterval) clearInterval(window.remainingTimeInterval);
        mineCircle.classList.remove('mining-active-glow');
        mineButton.disabled = true;
        mineButton.innerText = `üîí Watch Ads to Unlock`;
        mineButton.style.background = '#808080';
        countdownDisplay.innerText = `Watch ${window.ADS_REQUIRED - window.adsWatched} more ads to start.`;
    }
}


// --- WITHDRAWAL FUNCTIONS ---
window.showWithdrawalModal = () => {
    withdrawalModal.style.display = "block";
    document.getElementById('upiAmount').value = '';
    document.getElementById('upiId').value = window.upiId;
    document.getElementById('inrValueText').innerText = '';
    submitWithdrawalBtn.disabled = true;
}

window.closeWithdrawalModal = () => {
    withdrawalModal.style.display = "none";
}

window.checkWithdrawalEligibility = () => {
    const amountInput = document.getElementById('upiAmount');
    const amount = Number(amountInput.value);
    const inrValueText = document.getElementById('inrValueText');
    
    inrValueText.style.color = '#90ee90';
    inrValueText.innerText = amount > 0 ? `Equivalent to ‚Çπ${(amount / 1000).toFixed(2)}` : '';

    if (amount >= MIN_WITHDRAWAL_COINS && amount <= window.coins) {
        submitWithdrawalBtn.disabled = false;
    } else {
        submitWithdrawalBtn.disabled = true;
        if (amount > 0 && amount < MIN_WITHDRAWAL_COINS) {
            inrValueText.innerText = `Error: Minimum is ${MIN_WITHDRAWAL_COINS} Coins.`;
            inrValueText.style.color = '#f44336';
        } else if (amount > window.coins) {
             inrValueText.innerText = `Error: Insufficient balance.`;
             inrValueText.style.color = '#f44336';
        }
    }
}

window.submitWithdrawal = () => {
    const amount = Number(document.getElementById('upiAmount').value);
    const upiId = document.getElementById('upiId').value.trim();

    if (amount < MIN_WITHDRAWAL_COINS || amount > window.coins) {
        WebApp.showAlert(`Withdrawal failed: Amount must be valid.`); return;
    }
    if (upiId.length < 5 || !upiId.includes('@')) {
        WebApp.showAlert("Withdrawal failed: Please enter a valid UPI ID."); return;
    }

    const newCoinBalance = window.coins - amount;
    window.updateDatabase({ coins: newCoinBalance, upiId: upiId });
    
    const withdrawalRequest = {
        userId: TELEGRAM_USER_ID, userName: USER_NAME, amount: amount,
        upiId: upiId, timestamp: Date.now(), status: 'Pending'
    };

    push(WITHDRAWALS_REF, withdrawalRequest).then(() => {
        closeWithdrawalModal();
        WebApp.showAlert(`Withdrawal of ${amount} Coins submitted successfully. Processing in 24 hours.`);
    }).catch(error => {
         WebApp.showAlert("Withdrawal failed to submit. Please try again.");
         window.updateDatabase({ coins: window.coins }); // Revert deduction
    });
}

window.onclick = function(event) {
    if (event.target == withdrawalModal) { window.closeWithdrawalModal(); }
}

// --- REFERRAL FUNCTIONS ---
window.shareReferralLink = () => {
    const link = document.getElementById('refLink').innerText;
    const shareText = `üí∞ Join CoinMine and start earning! Use my referral link: ${link}. You get 700 bonus Coins, and I get a 5% lifetime commission on your mining!`;
    WebApp.openTelegramLink(`https://t.me/share/url?url=${encodeURIComponent(link)}&text=${encodeURIComponent(shareText)}`);
}

// --- NEW FUNCTION TO COPY USER ID ---
window.copyUserId = () => {
    navigator.clipboard.writeText(TELEGRAM_USER_ID).then(() => {
        WebApp.showPopup({message: 'User ID Copied!'});
    }).catch(err => WebApp.showAlert('Failed to copy User ID.'));
}


// --- GIFT CODE FUNCTIONS ---
async function loadClaimSettings() {
    const snapshot = await get(CLAIM_SETTINGS_REF);
    claimSettings = snapshot.val() || {};
    const btn = document.getElementById('claimBtn1');
    const setting = claimSettings.claim1;
    if (setting && setting.url) {
        btn.onclick = () => window.claimCode(btn, setting.url);
    } else {
        btn.onclick = () => window.claimCode(btn, 'placeholder');
    }
    checkClaimStatus();
}

async function checkClaimStatus() {
    const claimContainer = document.getElementById('claimButtonContainer');
    const redeemedMsg = document.getElementById('redeemedMessage');
    const claimCode = claimSettings.claim1?.code;
    if (!claimCode) return;

    const snapshot = await get(ref(database, `redemptions_by_user/${TELEGRAM_USER_ID}`));
    const claimRedeemed = Object.values(snapshot.val() || {}).some(redemption => redemption.code === claimCode);

    claimContainer.style.display = claimRedeemed ? 'none' : 'block';
    redeemedMsg.style.display = claimRedeemed ? 'block' : 'none';
}

window.redeemCode = async () => {
    let code = document.getElementById("giftCode").value.trim().toUpperCase();
    if (code === "") { WebApp.showAlert("Please enter a gift code!"); return; }

    try {
        let codeData = null;
        if (claimSettings.claim1?.code === code) codeData = claimSettings.claim1;
        if (!codeData && claimSettings.common?.code === code) codeData = claimSettings.common;
        if (!codeData) { WebApp.showAlert("Invalid Gift Code!"); return; }

        const redemptionSnapshot = await get(ref(database, `redemptions_by_user/${TELEGRAM_USER_ID}`));
        const alreadyRedeemed = Object.values(redemptionSnapshot.val() || {}).some(r => r.code === code);
        if (alreadyRedeemed) { WebApp.showAlert("You have already redeemed this code."); return; }

        const coinsAwarded = codeData.coins;
        const redemptionData = { code, coins: coinsAwarded, redeemedAt: Date.now(), userId: TELEGRAM_USER_ID, userName: USER_NAME };

        window.coins += coinsAwarded;
        window.updateDatabase({ coins: window.coins }); 
        
        push(ref(database, `redemptions_by_user/${TELEGRAM_USER_ID}`), { code, coins: coinsAwarded });
        push(REDEEMED_CODES_REF, redemptionData); 

        WebApp.showPopup({message: `Code redeemed! üéâ You won ${coinsAwarded} coins!`});
        document.getElementById("giftCode").value = "";
        if (code === claimSettings.claim1?.code) checkClaimStatus();

    } catch (error) {
        console.error("Redemption Error:", error);
        WebApp.showAlert("Redemption failed! Please try again later.");
    }
}

window.claimCode = (button, url) => {
    if (!url || url === 'placeholder') { WebApp.showAlert("The link for this code is not available yet."); return; }
    WebApp.openLink(url);
}

// --- INIT and NAVIGATION FUNCTIONS ---
document.addEventListener('DOMContentLoaded', () => {
    document.getElementById('taskUserId').innerText = TELEGRAM_USER_ID;
    
    loadAdminSettings();
    loadUserData(); 
    loadLiveTasks();
    loadClaimSettings();
    loadWithdrawalHistory(); // Load user's history
});

window.showSection = (sectionId, button) => {
  document.querySelectorAll('.section').forEach(s=>s.style.display='none');
  document.getElementById(sectionId).style.display='block';
  document.querySelectorAll('.nav-btn').forEach(btn=>btn.classList.remove('active'));
  button.classList.add('active');
}
window.showProfile = () => { WebApp.showAlert(`User Profile:\nName: ${USER_NAME}\nID: ${TELEGRAM_USER_ID}`); } 
window.showMsg = () => { WebApp.showPopup({message: 'Welcome to CoinMine!'}); }

</script>
</body>
</html>```
